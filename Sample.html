---
title: "Lake Health Report"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    theme: spacelab
    css: Styles.css
    orientation: rows
---

```{r setup, include=FALSE}
library(flexdashboard)
library(dplyr)
library(lubridate)
library(ggplot2)
library(cowplot)
library(tidyverse)
library(readr)
library(leaflet)
library(leafgl)
library(sp)
library(sf)
library(shiny)
library(rmarkdown)
library(knitr)
library(meta)
library(stats)
library(wrapr)
library(ggrepel)
library(Kendall)
library(rkt)
library(readr)
library(trend)
library(mice)
library(rstatix)
library(zyp)
library(httr)
library(jsonlite)


#Source material/code
LPP_Cl <- read.csv("~/R Projects/Practice/LPP Lake Report R/LPP Lake Report/LPP_Cl.csv")
LPP_Ca <- read.csv("~/R Projects/Practice/LPP Lake Report R/LPP Lake Report/LPP_Ca.csv")
LPP_TP <- read.csv("~/R Projects/Practice/LPP Lake Report R/LPP Lake Report/LPP_TP.csv")
LPP_Sec <- read.csv("~/R Projects/Practice/LPP Lake Report R/LPP Lake Report/LPP_Sec.csv")

#Simple inline hook to keep significant digits to 1
inline_hook <- function(x){
  if(is.numeric(x)){
   formatted <- format(x, digits =1, nsmall=1) 
  } else {
    formatted <- x
  }
} 

knit_hooks$set(inline=inline_hook)

# Setting a function that is an auto filter 

filter_STN <- function(y)
  filter(y, STN == "2242")
```

```{r loading in data frame that contains yearly averages, also doing some filtering, message=FALSE, warning=FALSE, include=FALSE }

#########################################################
TP_Specific <- LPP_TP %>% 
 filter_STN() %>% 
  mutate(Year = lubridate::year(Date),
         Month = lubridate::month(Date))

TP_Specific <- TP_Specific %>% 
  group_by(Site.ID) %>% 
  filter(n() >= 8) %>% 
  reframe(LAKE_NAME, STN, Site.ID, Shield., TP, Year, Month) %>% 
  ungroup() 

Annual_TP_Specific <- TP_Specific %>% 
  group_by(Year) %>%
  reframe(TP = mean(TP), Year, LAKE_NAME, STN, Month) %>%
  distinct() %>% 
  ungroup() %>% 
  filter(Month == "4" | Month == "5" | Month == "6")


########################################################
Ca_Specific <- LPP_Ca %>% 
 filter_STN() %>% 
  mutate(Year = lubridate::year(Date),
         Month = lubridate::month(Date))

Ca_Specific <- Ca_Specific %>% 
  group_by(Site.ID) %>% 
  filter(n() >=3) %>% 
  reframe(LAKE_NAME, STN, Site.ID, Shield., Ca, Year, Month) %>% 
  ungroup() 

Annual_Ca_Specific <- Ca_Specific %>% 
  group_by(Year) %>%
  reframe(Ca = mean(Ca), Year, LAKE_NAME, STN, Month) %>% 
  distinct() %>% 
  ungroup() %>% 
  filter(Month == "4" | Month == "5" | Month == "6")

######################################################
Cl_Specific <- LPP_Cl %>% 
  filter_STN() %>% 
  mutate(Year = lubridate::year(Date),
         Month = lubridate::month(Date))

Cl_Specific <- Cl_Specific %>% 
  group_by(Site.ID) %>% 
  filter(n() >=3) %>% 
  reframe(LAKE_NAME, STN, Site.ID, Shield., Cl, Year, Month) %>% 
  ungroup() 

Annual_Cl_Specific <- Cl_Specific %>% 
  group_by(Year) %>%
  reframe(Cl = mean(Cl),Year, LAKE_NAME, Year, Month) %>% 
  distinct() %>% 
  ungroup() %>% 
  filter(Month == "4" | Month == "5" | Month == "6")
########################################################
Sec_Specific <- LPP_Sec %>% 
  filter_STN() %>% 
  mutate(Year = lubridate::year(Date),
         Month = lubridate::month(Date))

Sec_Specific <- Sec_Specific %>% 
  group_by(Site.ID) %>% 
  filter(n() >=8) %>% 
  reframe(LAKE_NAME, STN, Site.ID, Shield., Secchi, Year, Month) %>% 
  ungroup() 

Annual_Sec_Specific <- Sec_Specific %>% 
  group_by(Year) %>%
  reframe(Secchi = mean(Secchi), Year, LAKE_NAME, Month) %>%
  distinct() %>% 
  ungroup() %>% 
  filter(Month == "6" | Month == "7" | Month == "8")

#########################################################
```

``` {r making reverable variables for text}
### Making an easily accessible variable to refer to Lake Name and Year and stuff
Lake_Name <- subset(Annual_TP_Specific [ 1 , 3]) 
###
Year_Character_TP <- Annual_TP_Specific$Year

Year_Character_TP <- as.character(Year_Character_TP)

Year_Character_Ca <- Annual_Ca_Specific$Year

Year_Character_Ca <- as.character(Year_Character_Ca)

Year_Character_Sec <- Annual_Sec_Specific$Year

Year_Character_Sec <- as.character(Year_Character_Sec)

Year_Character_Cl <- Annual_Cl_Specific$Year

Year_Character_Cl <- as.character(Year_Character_Cl)
```

```{r setting up a big df for map based on previous 6 yrs still need to group by sites, include=FALSE}

LPP_TP_p6yrs <- TP_Specific %>% 
  filter(Year >= "2017")

LPP_TP_p6yrs <- LPP_TP_p6yrs %>% 
  group_by(STN, Site.ID) %>% 
  mutate(TP_p6yrs = mean(TP)) %>% 
  reframe(STN, Site.ID, LAKE_NAME, TP_p6yrs, Shield.) %>% 
  distinct() %>% 
  ungroup()

##########################

LPP_Cl_p6yrs <- Cl_Specific %>% 
  filter(Year >= "2017")

LPP_Cl_p6yrs <- LPP_Cl_p6yrs %>% 
  group_by(STN, Site.ID) %>% 
  mutate(Cl_p6yrs = mean(Cl)) %>% 
  reframe(STN, Site.ID, LAKE_NAME, Cl_p6yrs, Shield.) %>% 
  distinct() %>% 
  ungroup()

##########################

LPP_Ca_p6yrs <- Ca_Specific %>% 
  filter(Year >= "2017")

LPP_Ca_p6yrs <- LPP_Ca_p6yrs %>% 
  group_by(STN, Site.ID) %>% 
  mutate(Ca_p6yrs = mean(Ca)) %>% 
  reframe(STN, Site.ID, LAKE_NAME, Ca_p6yrs, Shield.) %>% 
  distinct() %>% 
  ungroup()

##########################

LPP_Sec_p6yrs <- Sec_Specific %>% 
  filter(Year >= "2017")

LPP_Sec_p6yrs <- LPP_Sec_p6yrs %>% 
  group_by(STN, Site.ID) %>% 
  mutate(Secchi_p6yrs = mean(Secchi)) %>% 
  reframe(STN, Site.ID, LAKE_NAME, Secchi_p6yrs, Shield.) %>% 
  distinct() %>% 
  ungroup()

##########################
#Making final data frame for last 6 years of data for the map  

LPP_p6yrs <- LPP_TP_p6yrs %>% 
  left_join(LPP_Ca_p6yrs)

LPP_p6yrs <- LPP_p6yrs %>% 
  left_join(LPP_Cl_p6yrs)

LPP_p6yrs <- LPP_p6yrs %>% 
  left_join(LPP_Sec_p6yrs)

LPP_p6yrs <- LPP_p6yrs %>% 
  mutate(TP = TP_p6yrs, Ca = Ca_p6yrs, Cl = Cl_p6yrs, Secchi = Secchi_p6yrs) %>% 
  reframe(STN, Site.ID, LAKE_NAME, Shield., TP, Ca, Cl, Secchi)

LPP_p6yrs_STN <- LPP_p6yrs %>% 
  group_by(STN) %>% 
  mutate(TP = mean(TP), Ca = mean(Ca), Cl = mean(Cl), Secchi = mean(Cl)) %>% 
   reframe(STN, LAKE_NAME, Shield., TP, Ca, Cl, Secchi)


```

```{r making the dataframes and polygons and such for map, include=FALSE}

STN_sp <- read_sf("LPP_May_19_2020.gpkg", layer = "centroids") #this is to s

## Now I must convert lat long csv to spatial values
STN_site_centroids <- read.csv("lat and long.csv")
#removing all rows with null values
STN_site_centroids <- STN_site_centroids %>% 
  drop_na() %>% #added Na because I think some defaulted to that idk why
  filter(Latitude != "0", Latitude != "0")
#Setting the projection system for the shapefile (The projection system the file uses is WGS 84)
PRJ <- st_crs(STN_sp)
##Now to turn the long and lat it actual shapefile
STN_site_centroids <- st_as_sf(STN_site_centroids, coords =c("Longitude", "Latitude"), crs = PRJ)

STN_site_centroids <- STN_site_centroids %>% 
  filter_STN()

##############################################

LPP_STN_sites <- read.csv("LPP_updated.csv")

LPP_STN_sites <- LPP_STN_sites %>% 
  group_by(STN) %>% 
  slice_head(n = 1) %>% 
  reframe(LAKE_NAME, STN, DISTRICT.COUNTY, TOWNSHIP, Longitude, Latitude) %>% 
  filter_STN() %>% 
  ungroup()
  
get_polygon_lake <- function(long, lat){
  Query <- "?geometry={point}&geometryType=esriGeometryPoint&inSR=4326&f=geojson"
  waterbodyURL = "https://ws.lioservices.lrc.gov.on.ca/arcgis2/rest/services/LIO_OPEN_DATA/LIO_Open01/MapServer/25/query"
    point = paste0(c(long, lat), collapse = ",")
    QueryUrl <- paste0(waterbodyURL,glue::glue(Query))
    read_sf(QueryUrl)
}

STN_poly <- map_df(1:1, function(x){temp_poly <-
  get_polygon_lake(long = LPP_STN_sites$Longitude[x], lat = LPP_STN_sites$Latitude[x])
temp_poly$STN = LPP_STN_sites$STN[x]
temp_poly
})

#bbox_wrap <- function(x) st_as_sfc(st_bbox(x))

#WB <- WB %>% rowwise() %>%  
 # mutate(bbox = bbox_wrap(geometry)) %>% 
  #st_drop_geometry()
###############################################

#Data_sites <- LPP_TP_p6yrs %>% #importing the LPP data (in future I will have to import the Ca, Cl, and Secchi data into this, I think)
  #filter_STN()

#Data_poly <- LPP_TP %>% #importing the LPP data (in future I will have to import the Ca, Cl, and Secchi data into this, I think)
 # group_by(STN) %>%
  #mutate(TP = mean(TP)) %>%
  #distinct(TP) %>% 
  #ungroup() %>% 
  #filter_STN()
 
```

Overview
=========================================
### <font size = "+4">**`r str_to_title(Lake_Name[1])`** </font size> 
<font size = "+3"> **STN `r Annual_TP_Specific$STN[1]`** </font size>

This is an overview of the Lake Health Report provided by the Lake Partner Program.
The Lake Partner Program (LPP) is a volunteer-based, inland lake water quality monitoring program in Ontario. The LPP enables lake stewards to monitor total phosphorus, calcium, chloride, and water clarity. `r str_to_title(Lake_Name[1])` has been apart of the Lake Partner Program from `r min(Year_Character_TP)` to `r max(Year_Character_TP)`. Precise, low-level total phosphorus data have been collected since 2002, and calcium and chloride concentrations were added in 2008 and 2015, respectively.
<br><br>
Sampling in the Lake Partner Program begins approximately 2-weeks after ice-off on any given lake. Lakes located on the the Precambrian Shield (90% of lakes in LPP) get sampled for total phosphorus, calcium, and chloride once per year, approximately 2-weeks after ice-off. Secchi disk samples occur monthly throughout the entire sampling season (May-October). For lakes that are not located on the Precambrian shield sampling in all forms occurs monthly throughout the sampling season. For information on why we sample ON and OFF Shield lakes differently refer to the total phosphorus section. 
<br><br> 
The mission of the Lake Partner Program is to foster interest & promote stewardship of water quality across Ontario & maintain a long-term database of water quality for Ontario’s inland lakes. The objectives include but are not limited to tracking long-term trends in total phosphorus and water clarity, and in more recent years, calcium and chloride, reporting and utilizing the water quality data collected, identifying emerging water quality issues in Ontario's inland lakes, maintaining a water quality database, and working in cooperation with volunteers and partners. 

### As of May 2023, there are:

Row
-----------------------------------------------------------------------
### Program volunteers
```{r}
valueBox(628, icon = "fa-hand-paper-o")
```
### Lakes Monitored
```{r}
valueBox(542, icon = "ion-android-boat")
```
### Sites Monitored
```{r}
valueBox(923, icon = "ion-android-compass")
```



Row {data-height=750}
------------------------------------------------------------------------
### `r str_to_title(Lake_Name[1])` averages over past 6 years

```{r map code chunk, echo=FALSE, height='80%', out.height='50%', out.width='100%', width='100%'}


STN_poly_All <- STN_poly %>% left_join(LPP_p6yrs %>% mutate(STN = as.numeric(STN)))

STN_poly_All <- STN_poly_All %>% 
   drop_na()

STN_sites_All <- STN_site_centroids %>% left_join(LPP_p6yrs %>% mutate(STN = as.numeric(STN)))

STN_sites_All <- STN_sites_All %>% 
   drop_na()

leaflet(data = STN_poly_All) %>% 
  addTiles(
    urlTemplate = "https://tiles.stadiamaps.com/tiles/stamen_toner_lite/{z}/{x}/{y}{r}.png?api_key=79d3780c-50d9-4832-bcd0-42e68686a10c",
    attribution = paste('&copy; <a href="https://stadiamaps.com/" target="_blank">Stadia Maps</a>' ,
                            '&copy; <a href="https://www.stamen.com/" target="_blank">Stamen Design</a>' ,
                            '&copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a>' ,
                            '&copy; <a href="https://www.openstreetmap.org/about/" target="_blank">OpenStreetMap contributors</a>
'),
    options = tileOptions(variant='stamen_toner_lite', apikey = '79d3780c-50d9-4832-bcd0-42e68686a10c')
    ) %>% 
  addPolygons(data= STN_poly_All, fillColor = "white", color = "darkgreen", fillOpacity = .4,popup = ~paste(OFFICIAL_NAME_LABEL, "<br> Mean TP", round(TP, 1), "µg/L", "<br> Mean Ca", round(Ca, 1), "mg/L", "<br> Mean Cl", round(Cl, 1), "mg/L", "<br> Mean Secchi", round(Secchi, 1), "m")) %>% 
  addCircleMarkers(data= STN_sites_All, radius = 6, color = "black", fillColor = "black", fillOpacity = 1,
   popup = ~paste("Site", Site.ID, "<br> Mean TP", round(TP, 1), "µg/L", "<br> Mean Ca", round(Ca, 1), "mg/L", "<br> Mean Cl", round(Cl, 1), "mg/L", "<br> Mean Secchi", round(Secchi, 1), "m"))


```

>**Figure 1.**  A map showing `r str_to_title(Lake_Name[1])` and the sites measured in the LPP. Each site displays the mean of each parameter measured for the past 5 years. Sites with insufficent data were excluded from analysis. All data were collected by Lake Partner volunteers from 2017-2022.

Row {data-height=365}
-------------------------------------------------------------------------
### History of the Lake Partner Program

The Lake Partner Program (LPP) began in 1996. The program evolved from the Ministry’s Self Help Program, which collected information on chlorophyll and water since the early 1970s. In 2002, the LPP relocated from Toronto to the Dorset Environmental Science Centre, where low-level total phosphorus analyses were completed. The program continued to grow throughout the 2000s as the number of volunteers increased. 
<br>
The Lake Partner Program has partnered with the Federation of Ontario Cottager’s Associations (FOCA) since the start of the program in 1996. Through this partnership, FOCA provides outreach and stewardship to Ontario’s lakefront communities and distributes water quality information to the public through their website, presentations, and email communications.

Row {data-height=290}
-------------------------------------------------------------------
### Federation of Ontario Cottagers' Associations

The Federation of Ontario Cottagers’ Associations (FOCA) is a not-for-profit membership organization that has been the voice of the Ontario waterfront since 1963. Today, FOCA has over 525 lake, road and residents’ association members, representing 50,000 waterfront property owning families across the province. FOCA’s Lake Stewards are the backbone of the Lake Partner Program, the hundreds of volunteer water quality monitors who collect the annual water samples and secchi depth readings that make up the LPP dataset. Learn more: https://foca.on.ca/lake-partner-program/ 


Row {data-height=180}
--------------------------------------------------------------------------
### Purpose of the Lake Health Report

This report provides background information on Ontario’s Lake Partner Program and summarizes each of the four water quality indicators monitored as part of the program (total phosphorus, calcium, chloride, and water clarity). This report is was created for `r str_to_title(Lake_Name[1])`'s Lake Partner Volunteers using the data they collected. 



***<font size="-1"> The LPP measures water quality in inland lakes across Ontario. The data is collected through volunteer monitoring efforts - citizen science. You can download the data set used in this analysis by visiting the Ontario Open Data Catalog at data.ontario.ca/dataset/ontario-lake-partner </font>***

Total Phosphorus
========================================
### **<font size = "+3"> What is total phosphorus? </font>** {.totalp}
Phosphorus is an essential element for aquatic systems and the organisms that inhabit them. Phosphorus is one of the factors that control growth of algae in most Ontario lakes. Increases in lake phosphorus concentrations may enhance algal growth, resulting in decreased water clarity, reduced deep-water oxygen concentrations, and, in extreme cases, cause algal blooms that may produce toxins, affect the aesthetics of the lake, and/or cause taste and odor problems in the water.
<br><br>
In the LPP, we measure *total phosphorus* (TP) concentrations, which is an indication of all of the phosphorus in a water sample. Lakes can be placed in three broad categories with respect to nutrients such as TP. Lakes with less than 10 µg/L are considered oligotrophic. These dilute, unproductive lakes rarely experience algal blooms. Lakes with TP between 10 and 20 µg/L are termed mesotrophic and are in the middle with respect to trophic status. These lakes show a susceptible to moderate algal blooms at concentrations near 20 µg/L. Lakes over 20 µg/L are classes as eutrophic and may exhibit persistent, nuisance and algal blooms.
<br><br>
Geographically, `r str_to_title(Lake_Name[1])` is located off the Precambrian Shield in Ontario. In the LPP, these "off-Shield" lakes are sampled monthly because they are more likely to show seasonal variability in TP concentrations. Many of the complex seasonal processes in these lakes would be difficult to assess without the data that volunteers collect on a monthly basis. 

Row {data-height=750}
---------------------------------------
### `r str_to_title(Lake_Name[1])`'s average total phosphorus concentration.
```{r Total Phosphorus map only, echo=FALSE, height='100%', out.height='45%', out.width='100%', width='100%'}
Data_sites_TP <- LPP_TP %>% #importing the LPP data (in future I will have to import the Ca, Cl, and Secchi data into this, I think)
  group_by(STN, Site.ID) %>% # might need to do a filter some to limit the amount of sites some lake have
  mutate(TP = mean(TP)) %>%
  distinct(Site.ID, TP) %>% 
  ungroup() %>% 
  filter_STN()

Data_poly_TP <- LPP_TP %>% #importing the LPP data (in future I will have to import the Ca, Cl, and Secchi data into this, I think)
  group_by(STN) %>%
  mutate(TP = mean(TP)) %>%
  distinct(TP) %>% 
  ungroup() %>% 
  filter_STN()
 

STN_TROPHIC_poly_TP <- STN_poly %>% left_join(Data_poly_TP %>% mutate(STN = as.numeric(STN))) %>% 
  mutate(trophic_cat = case_when(
   TP < 10.001 ~ "oligotrophic 0-10 (µg/L)", TP > 20.0001 ~ "eutrophic 20-30 (µg/L)", TRUE ~ "mesotrophic 10-20 (µg/L)"),
    trophic_cat = factor(trophic_cat, levels = c("oligotrophic 0-10 (µg/L)", "mesotrophic 10-20 (µg/L)", "eutrophic 20-30 (µg/L)"))) %>%
  na.omit()

STN_TROPHIC_sites_TP <- STN_site_centroids %>% left_join(Data_sites_TP %>% mutate(STN = as.numeric(STN))) %>% 
  mutate(trophic_cat = case_when(
    TP < 10.001 ~ "oligotrophic 0-10 (µg/L)", TP > 20.0001 ~ "eutrophic 20-30 (µg/L)", TRUE ~ "mesotrophic 10-20 (µg/L)"),
    trophic_cat = factor(trophic_cat, levels = c("oligotrophic 0-10 (µg/L)", "mesotrophic 10-20 (µg/L)", "eutrophic 20-30 (µg/L)"))) %>%
  na.omit()

pal2 = colorFactor(palette = c("chartreuse","green3","darkgreen"), c("oligotrophic 0-10 (µg/L)", "mesotrophic 10-20 (µg/L)", "eutrophic 20-30 (µg/L)")) #pal2 is the colour palette used here for the trophic status'

labels <- labels <- c("oligotrophic (0-10 ug/L)", "mesotrophic (10-20 ug/L)", "eutrophic 20-30 (µg/L)", ordered = FALSE) #defines legend labels
##################################################

leaflet(data = STN_TROPHIC_poly_TP) %>% 
  addTiles(
    urlTemplate = "https://tiles.stadiamaps.com/tiles/stamen_toner_lite/{z}/{x}/{y}{r}.png?api_key=79d3780c-50d9-4832-bcd0-42e68686a10c",
    attribution = paste('&copy; <a href="https://stadiamaps.com/" target="_blank">Stadia Maps</a>' ,
                            '&copy; <a href="https://www.stamen.com/" target="_blank">Stamen Design</a>' ,
                            '&copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a>' ,
                            '&copy; <a href="https://www.openstreetmap.org/about/" target="_blank">OpenStreetMap contributors</a>
'),
    options = tileOptions(variant='stamen_toner_lite', apikey = '79d3780c-50d9-4832-bcd0-42e68686a10c')
    ) %>%  
  addLegend(title = "Trophic Categories (Mean TP)", pal = pal2,
            values = ~trophic_cat, opacity = 1) %>%
   addPolygons(data= STN_TROPHIC_poly_TP, color = "darkgrey",
   fillColor = ~pal2(trophic_cat),
   popup = ~paste(OFFICIAL_NAME_LABEL, "<br> Mean TP", round(TP, 1), "µg/L")) %>% 
  addCircleMarkers(data= STN_TROPHIC_sites_TP, radius = 8, color = ~pal2(trophic_cat),
   fillColor = ~pal2(trophic_cat),
   popup = ~paste("Site", Site.ID, "<br> Mean TP", round(TP, 1), "µg/L"))

```

>**Figure 2.** A map showing `r str_to_title(Lake_Name[1])` and the sites measured in the LPP. Sites with insufficent data were excluded from analysis. Symbols representing each sampling site are colored based on the trophic category of the lake. Lakes with less than 10 µg/L are considered oligotrophic. These dilute, unproductive lakes rarely experience algal blooms. Lakes with TP between 10 and 20 µg/Lare termed mesotrophic and are in the middle with respect to trophic status. These lakes show a susceptible to moderate algal blooms at concentrations near 20 µg/L. lakes over 20 µg/L are classes as eutrophic and may exhibit persistent, nuisance and algal blooms. All data was collected by Lake Partner volunteers after ice-off of each year.

Row {data-height=750}
---------------------------------------
### **How does `r str_to_title(Lake_Name[1])` compare to other OFF-shield lakes in the Lake Partner Program?**
<br> <br>

```{r setitng up Historgram for all of Ontario, message=FALSE, warning=FALSE, include=FALSE}
Lake_AVG_TP_ON <- LPP_TP %>% 
  mutate(Year = lubridate::year(Date),
         Month = lubridate::month(Date)) %>% 
  filter(Month == "4" | Month == "5" | Month == "6")

Lake_AVG_TP_ON <- Lake_AVG_TP_ON %>% 
  group_by(STN) %>% 
  mutate(TP = mean(TP)) %>% 
  reframe(STN, LAKE_NAME, TP, Shield.) %>% 
  distinct() %>%
  filter(Shield. == "TRUE") %>% 
  ungroup()
  
Lake_AVG_TP_ON <- Lake_AVG_TP_ON %>% 
  mutate(percentile = ((rank(TP)/length(TP))*100))

Specific_Percentile_TP <- Lake_AVG_TP_ON %>% 
  filter_STN() %>%
  mutate(percentile = round(percentile, 0)) 
  
Percentile_only_TP <- as.character(Specific_Percentile_TP$percentile) 

```

```{r Histogram for all of Ontario, echo=FALSE, fig.height=4, fig.width=10, message=FALSE, warning=FALSE}

ggplot(Lake_AVG_TP_ON) +
  geom_histogram(binwidth = 2, color = "white", aes(x = TP, y=(after_stat(count)/sum(after_stat(count))*100)))+
  labs(x = "Total Phosphorus (µg/L)", y = "Lakes (%)")+
  scale_x_continuous(limits = c(0, 34), breaks = seq(0,34, by = 2), guide = guide_axis(order = 2)) +
  geom_vline(xintercept = 20, linetype = "longdash") +
  geom_text(aes(x=20, label="PWQO = 20 μg/L", y= 12), colour="springgreen4", angle=90, vjust = -.75, size = 4) +
  geom_text(aes(x = (mean(Annual_TP_Specific$TP)),label=(Annual_TP_Specific$LAKE_NAME[1]) ,y= 20), colour="springgreen4", hjust = -0.1, size = 4)+
  geom_vline(xintercept = (mean(Annual_TP_Specific$TP)), linetype= "twodash")+
  theme_classic(base_size = 19) +
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 15), 
        axis.title.y = element_text(vjust = 2),
        axis.title.x = element_text(vjust = -0.5)) 

```

>**Figure 3.** Histogram showing the distribution of total phosphorus (TP) concentrations for all On-Shield lakes in the LPP from `r min(Year_Character_TP)` to `r max(Year_Character_TP)`. The dash and dot line represents `r str_to_title(Lake_Name[1])` average total phosphorus concentrations and the dashed line shows the Provincial Water Qaulity Objective of 20 µg/L of total phosphorus. Only total phosphorus data from April, May, and June were used in this histogram. 

Row 
----------------------------------------
### Takeaways from `r str_to_title(Lake_Name[1])`'s comparison to other off-Shield lakes: {.takeawayfig3}

-	The average TP concentrations between `r min(Year_Character_TP)` and `r max(Year_Character_TP)` is `r mean(Annual_TP_Specific$TP)` µg/L.

- `r str_to_title(Lake_Name[1])` falls into the `r Percentile_only_TP`th percentile of TP concentrations in off-shield lakes. Meaning `r str_to_title(Lake_Name[1])` is `r if(between(Specific_Percentile_TP$percentile, 0, 50) == TRUE) {"in the lower 50% of On-Shield lakes in the LPP, regarding TP concentrations."}` `r if(between(Specific_Percentile_TP$percentile, 51, 100) == TRUE) {"in the upper 50% of On-Shield lakes in the LPP, regarding TP concentrations."}`

- `r str_to_title(Lake_Name[1])` is `r if(between((mean(Annual_TP_Specific$TP)), 0, 19.99) == TRUE) {"below the provincial water quality objective of 20 µg/L"}` `r if((mean(Annual_TP_Specific$TP)) > 20) {"above the provincial water quality objective of 20 µg/L."}`


Row {data-height=750}
--------------------------------------------
```{r r-test to be displayed on next figure }
R_value_TP <- cor.test(Annual_TP_Specific$TP, Annual_TP_Specific$Year)
R_value_TP <- R_value_TP$estimate
R_value_TP <- unname(R_value_TP)

test <- Annual_TP_Specific %>% 
  reframe(Year, TP)

# MannKendall(Annual_TP_Specific)

mean_TP_ON_shield <- LPP_TP %>% 
  filter(Shield. == "TRUE") %>% 
  mutate(mean = mean(TP)) %>% 
  slice_head()

Max_Year_TP <- Annual_TP_Specific %>% 
  arrange(desc(TP)) %>% 
  slice_head()
Max_Year_TP <- as.character(Max_Year_TP)


Min_Year_TP <- Annual_TP_Specific %>% 
  arrange(TP) %>% 
  slice_head() 
Min_Year_TP <- as.character(Min_Year_TP)
```
### What does `r str_to_title(Lake_Name[1])`'s annual total phosphorus concentrations look like?
<br> <br>
```{r Annual TP graph, fig.height=3.5, fig.width=10, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(Lake_AVG_TP_ON) +
  geom_histogram(binwidth = 2, color = "white", aes(x = TP, y=(after_stat(count)/sum(after_stat(count))*100)))+
  labs(x = "Total Phosphorus (µg/L)", y = "Lakes (%)")+
  scale_x_continuous(limits = c(0, 34), breaks = seq(0,34, by = 2), guide = guide_axis(order = 2)) +
  geom_vline(xintercept = 20, linetype = "longdash") +
  geom_text(aes(x=20, label="PWQO = 20 μg/L", y= 12), colour="springgreen4", angle=90, vjust = -.75, size = 4) +
  geom_text(aes(x = (mean(Annual_TP_Specific$TP)),label=(Annual_TP_Specific$LAKE_NAME[1]) ,y= 15), colour="springgreen4", hjust = -0.1, size = 4)+
  geom_vline(xintercept = (mean(Annual_TP_Specific$TP)), linetype= "twodash")+
  theme_classic(base_size = 19) +
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 15), 
        axis.title.y = element_text(vjust = 2),
        axis.title.x = element_text(vjust = -0.5))
```

>**Figure 4.** A line plot showing that `r str_to_title(Lake_Name[1])` `r if(between(R_value_TP, -10, -0.1) == TRUE) {"declined in total phosphorus by approximately"}` `r if(between(R_value_TP, 0.1, 10) == TRUE) {"increased in total phosphorus by approximately"}` `r if(between(R_value_TP, -0.1, 0.1) == TRUE) {"stayed relatively the same throughout its time in the LPP with an R value of"}` `r R_value_TP` µg/L per year from `r min(Year_Character_TP)` to `r max(Year_Character_TP)`. All data was collected by LPP volunteers and only data from April, May and June were used in this analysis.


Row 
----------------------------------------
### Take aways from `r str_to_title(Lake_Name[1])`'s annual total phosphorus: {.takeawayfig4}

- This lake is a `r if(between((mean(Annual_TP_Specific$TP)), 0, 9.99) == TRUE) {"oligotrophic"}` `r if(between((mean(Annual_TP_Specific$TP)), 10.00, 19.99) == TRUE) {"mesotrophic"}``r if(between((mean(Annual_TP_Specific$TP)), 20, 100) == TRUE) {"eutrophic"}` lake. The trophic status refers to the overall biological productivity of the lake. `r if(between((mean(Annual_TP_Specific$TP)), 0, 9.99) == TRUE) {"Oligotrophic lake biological activity is relativley low and total phopshorus concentrations range from 0-10 µg/L."}``r if(between((mean(Annual_TP_Specific$TP)), 10.00, 19.99) == TRUE) {"Mesotrophic lakes have TP concentrations between 10-20 µg/L and have a moderate amount of biological productivity."}``r if(between((mean(Annual_TP_Specific$TP)), 20, 100) == TRUE) {"Eutrophic lakes have TP concentrations between 20-30 µg/L and have high concentrations of biological productivity and likely have high amounts of algae growth."}`

- Annually the phosphorus in `r str_to_title(Lake_Name[1])` had `r if(between(R_value_TP, -100, -0.1) == TRUE) {"fallen by"}` `r if(between(R_value_TP, 0.1, 100) == TRUE) {"risen by"}` `r if(between(R_value_TP, -0.1, 0.1) == TRUE) {"stayed relatively the same throughout its time in the LPP with an R value of"}` `r R_value_TP` µg/L.  

- `r str_to_title(Lake_Name[1])` has some variability in total phosphorus concentrations from year-to-year. For example TP concentrations have ranged from `r min(Annual_TP_Specific$TP)` µg/L in `r Min_Year_TP[1]` to `r max(Annual_TP_Specific$TP)` (µg/L) in `r Max_Year_TP[1]` since testing began in `r min(Year_Character_TP)`. Due to the number of years of data for `r str_to_title(Lake_Name[1])`, we can assume this variability is representative of normal conditions for this lake. 

Row {data-height=90}
----------------------------------------------
***<font size="-1"> The LPP measures water quality in inland lakes across Ontario. The data is collected through volunteer monitoring efforts - citizen science. You can download the data set used in this analysis by visiting the Ontario Open Data Catalog at data.ontario.ca/dataset/ontario-lake-partner </font>***

Calcium
=========================================
### <font size = "+3"> **What is calcium?** </font>

Many aquatic animals are sensitive to changes in calcium, such as mollusks, clams, amphipods, and crayfish. For example, tiny organisms called Daphnia, a primary food for many fish, are susceptible to decreasing calcium levels. DESC partner laboratory experiments have shown that the reproduction of most Daphnia species is jeopardized at lake calcium concentrations below 1.5 mg/L. In nature, where organisms must cope with multiple stressors, such as warmer temperatures expected with climate change, this threshold for calcium concentration is expected to be higher.
<br>
Under natural conditions (i.e., without human influence), calcium concentrations in soils are based on inputs from mineral weathering of rocks and atmospheric deposition, and losses through uptake by growing forests, and leaching to lakes and rivers. Calcium concentrations in Canadian Shield lakes have decreased over the last 35 years. Decades of acid rain, combined with deforestation, have depleted watershed stores of Calcium. Further declines are expected in many lakes. As a result, the LPP began monitoring calcium concentrations in 2008, to observe trends and identify lakes that may be sensitive to calcium decline.


Row {data-height=750}
--------------------------------------------

### How does `r str_to_title(Lake_Name[1])` calcium concentrations compare to other On-Shield lakes?
```{r setting up for Ca Histogram, include=FALSE}
Lake_AVG_Ca_ON <- LPP_Ca %>% 
  mutate(Year = lubridate::year(Date),
         Month = lubridate::month(Date)) %>% 
  filter(Month == "4" | Month == "5" | Month == "6")

Lake_AVG_Ca_ON <- Lake_AVG_Ca_ON %>% 
  group_by(STN) %>% 
  mutate(Ca_AVG = mean(Ca)) %>% 
  reframe(STN, LAKE_NAME, Ca_AVG, Shield.) %>% 
  distinct() %>%
  filter(Shield. == "TRUE") %>% 
  ungroup()

Lake_AVG_Ca_ON <- Lake_AVG_Ca_ON %>% 
  mutate(percentile = ((rank(Ca_AVG)/length(Ca_AVG))*100))

Specific_Percentile_Ca <- Lake_AVG_Ca_ON %>% 
  filter_STN() %>%
  mutate(percentile = round(percentile, 0)) 
  
Percentile_only_Ca <- as.character(Specific_Percentile_Ca$percentile) 

```

```{r Histogram for all of Ontario Ca, echo=FALSE, fig.height=3.5, fig.width=10, message=FALSE, warning=FALSE}

ggplot(Lake_AVG_Ca_ON)+
  geom_histogram(binwidth = 5, color = "white", aes(x = Ca_AVG, y=(after_stat(count)/sum(after_stat(count))*100)))+
  labs(x = "Calcium (mg/L)", y = "Lakes (%)")+
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 60, by = 5), guide = guide_axis(check.overlap = TRUE))+
  scale_y_continuous(limits = c(0,20), breaks = seq(0, 20, by = 2))+
  geom_vline(xintercept = 1.5, linetype = "longdash") +
  geom_text(aes(x=1.5, label= "Ca threshold level", y=8), colour="springgreen4", angle=90, vjust= -0.1, size = 4) +
  geom_vline(xintercept = (mean(Annual_Ca_Specific$Ca)), linetype = "longdash")+
  geom_text(aes(x = (mean(Annual_Ca_Specific$Ca)), y = 14.5, label = (Annual_Ca_Specific$LAKE_NAME[1])), colour="springgreen4", hjust= -0.1, size = 4)+
  theme_cowplot() +
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 10), 
        axis.title.y = element_text(vjust = 2),
        axis.title.x = element_text(vjust = -0.5))

```

>**Figure 6.** Histogram showing the distribution of calcium (Ca) concentrations for all On-Shield lakes in the LPP from `r min(Year_Character_Ca)` to `r max(Year_Character_Ca)`. The dash and dot line represents `r str_to_title(Lake_Name[1])` average calcium concentrations and the dashed line shows the level at which aquatic species become at risk. All calcium samples were taken shortly after the ice-off period each spring. 

Row 
--------------------------------------------
### Highlights from `r str_to_title(Lake_Name[1])`'s comparison to other On-Shield lakes: {.takeawayfig6}

-	The average Ca concentration between `r min(Year_Character_Ca)` and `r max(Year_Character_Ca)` is `r mean(Annual_Ca_Specific$Ca)` mg/L.

- `r str_to_title(Lake_Name[1])` falls into the `r Percentile_only_Ca`th percentile of Ca concentrations in off-shield lakes. Meaning `r str_to_title(Lake_Name[1])` is `r if(between(Specific_Percentile_Ca$percentile, 0, 50) == TRUE) {"in the lower 50% of On-Shield lakes in the LPP, regarding Ca concentrations."}` `r if(between(Specific_Percentile_Ca$percentile, 51, 100) == TRUE) {"in the upper 50% of On-Shield lakes in the LPP, regarding Ca concentrations."}`

- `r str_to_title(Lake_Name[1])` is `r if(between((mean(Annual_Ca_Specific$Ca)), 0, 1.5) == TRUE) {"below the concentration in which aquatic species may be at risk (1.5 mg/L)."}` `r if((mean(Annual_Ca_Specific$Ca)) > 1.5) {"above the Ca concentrations in which species may be at risk (1.5 mg/L)."}`

Row {data-height=800}
--------------------------------------------
### What is `r str_to_title(Lake_Name[1])`'s annual calcium concentrations?
```{r setting up for annual Ca graph, include=FALSE}

R_value_Ca <- cor.test(Annual_Ca_Specific$Ca, Annual_Ca_Specific$Year)
R_value_Ca <- R_value_Ca$estimate
R_value_Ca <- unname(R_value_Ca)


Max_Year_Ca <- Annual_Ca_Specific %>% 
  arrange(desc(Ca)) %>% 
  slice_head()
Max_Year_Ca <- as.character(Max_Year_Ca)


Min_Year_Ca <- Annual_Ca_Specific %>% 
  arrange(Ca) %>% 
  slice_head() 
Min_Year_Ca <- as.character(Min_Year_Ca)


```

```{r annual Ca graph,fig.height=3, fig.width=10, echo=FALSE, message=FALSE, warning=FALSE}
ggplot()+
  geom_line(Annual_Ca_Specific, mapping = aes(x = Year, y = Ca), color = "Black", linewidth = 2) +
  labs(x = "Year", y = "Annual Ca (mg/L)")+ 
  geom_point(Annual_Ca_Specific, mapping = aes(x= Year, y = Ca), color = "Navy Blue", size = 5) +
  geom_smooth(Annual_Ca_Specific, mapping= aes(x= Year, y = Ca), linetype = 2, color = "Black") +
  theme_classic(base_size = 25) +
  geom_hline(data = LPP_Ca %>% filter(Shield. == "TRUE"), linetype= 2,##trying to figure out how to optimize this
             mapping = aes(yintercept = mean(Ca))) +
  geom_text(aes(label = "On Shield Lake Ca Average", x = 2013, y = (mean(LPP_Ca %>% filter(Shield.=="TRUE"))))) +
  geom_text(data=data.frame(), aes(label = paste("R-square =", round(R_value_Ca, 1)), x= -Inf, y= Inf), hjust = -6, vjust = 3.5, size= 4)


```

>**Figure 7.** A line plot showing that `r str_to_title(Lake_Name[1])` `r if(between(R_value_Ca, -10, -0.1) == TRUE) {"declined in calcium by approximately"}` `r if(between(R_value_Ca, 0.1, 10) == TRUE) {"increased in calcium  by approximately"}` `r if(between(R_value_Ca, -0.1, 0.1) == TRUE) {"stayed relatively the same throughout its time in the LPP with an R value of"}` `r R_value_Ca` mg/L per year from `r min(Year_Character_Ca)` to `r max(Year_Character_Ca)`. Data were collected through the LPP in the spring of each year.

Row
---------------------------------------------
### Highlights from `r str_to_title(Lake_Name[1])`'s annual calcium concentrations: {.takeawayfig7}
- Annually the Ca concentration in `r str_to_title(Lake_Name[1])` has `r if(between(R_value_Ca, -100, -0.1) == TRUE) {"fallen by"}` `r if(between(R_value_Ca, 0.1, 100) == TRUE) {"risen by"}` `r if(between(R_value_Ca, -0.1, 0.1) == TRUE) {"stayed relatively the same throughout its time in the LPP at a rate of"}` `r R_value_Ca` mg/L annually. 

- `r str_to_title(Lake_Name[1])` has some variability in Ca concentrations from year-to-year. For example Ca concentrations have ranged from `r min(Annual_Ca_Specific$Ca)` mg/L in `r Min_Year_Ca[1]` to `r max(Annual_Ca_Specific$Ca)` mg/L in `r Max_Year_Ca[1]` since testing began in `r min(Year_Character_Ca)`. Due to the number of years of data for `r str_to_title(Lake_Name[1])`, we can assume this variability is representative of normal conditions for this lake. 

Row {data-height=90}
----------------------------------------------
***<font size="-1"> The LPP measures water quality in inland lakes across Ontario. The data is collected through volunteer monitoring efforts - citizen science. You can download the data set used in this analysis by visiting the Ontario Open Data Catalog at data.ontario.ca/dataset/ontario-lake-partner </font>***

Chloride
==============================================
### <font size = "+3"> **What is chloride?** </font>
Chloride concentrations have risen in recent years in Ontario lakes located near roads. The increasing levels are due to road salt application for winter road maintenance and the use of dust suppressants at other times of the year. Aquatic organisms, in particular some types of zooplankton, are particularly sensitive to chloride, and the impacts may be amplified by other stresses, such as calcium decline.
<br>
Typically for freshwater lakes a chloride level less than 120 mg/L is considered ideal for aquatic health (CCME, 2011). But research has been conducted showing chloride levels well below 120 mg/L can have negative effects on organisms in freshwater lakes, specifically low nutirent, low calcium lakes (Yao et al, (2020)).

Row {data-height=750}
----------------------------------------

### How does `r str_to_title(Lake_Name[1])`'s chloride concentrations compare to other On-Shield lakes?
```{r setting up for Cl histogram, include=FALSE}
Lake_AVG_Cl_ON <- LPP_Cl %>% 
  mutate(Year = lubridate::year(Date),
         Month = lubridate::month(Date)) %>% 
  filter(Month == "4" | Month == "5" | Month == "6")

Lake_AVG_Cl_ON <- Lake_AVG_Cl_ON %>% 
  group_by(STN) %>% 
  mutate(Cl = mean(Cl)) %>% 
  reframe(STN, LAKE_NAME, Cl, Shield.) %>% 
  distinct() %>%
  filter(Shield. == "TRUE") %>% 
  ungroup()

Lake_AVG_Cl_ON <- Lake_AVG_Cl_ON %>% 
  mutate(percentile = ((rank(Cl)/length(Cl))*100))

Specific_Percentile_Cl <- Lake_AVG_Cl_ON %>% 
  filter_STN() %>%
  mutate(percentile = round(percentile, 0)) 
  
Percentile_only_Cl <- as.character(Specific_Percentile_Cl$percentile) 

```

```{r chloride histogram, echo=FALSE, fig.height=3, fig.width=10, message=FALSE, warning=FALSE}

ggplot(Lake_AVG_Cl_ON)+
  geom_histogram(binwidth = 2.5, color = "white", aes(x = Cl, y=(after_stat(count)/sum(after_stat(count))*100)))+
  labs(x = "Chloride (mg/L)", y = "Lakes (%)")+
  scale_x_continuous(limits = c(0,45), breaks = seq(0, 45, by = 5), guide = guide_axis(check.overlap = TRUE))+
  scale_y_continuous(limits = c(0,25), breaks = seq(0, 25, by = 5))+
  geom_vline(xintercept = (mean(Annual_Cl_Specific$Cl)), linetype = "longdash")+
  geom_text(aes(x = (mean(Annual_Cl_Specific$Cl)), y = 22, label = (Annual_Cl_Specific$LAKE_NAME[1])), colour="springgreen4", hjust= -0.1, size = 4)+
  theme_cowplot() +
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 10), 
        axis.title.y = element_text(vjust = 2),
        axis.title.x = element_text(vjust = -0.5))

```

>**Figure 8.** Histogram showing the distribution of chloride (Cl) concentrations for all On-Shield lakes in the LPP from `r min(Year_Character_Cl)` to `r max(Year_Character_Cl)`. The dash and dot line represents `r str_to_title(Lake_Name[1])` average calcium concentrations and the dashed line shows the level at which aquatic species become at risk. All calcium samples were taken shortly after the ice-off period each spring. 

Row
-----------------------------------
### Highlights from `r str_to_title(Lake_Name[1])`'s comparison to other on-Shield lakes: {.takeawayfig8}

-	The average Cl concentration between `r min(Year_Character_Cl)` and `r max(Year_Character_Cl)` is `r mean(Annual_Cl_Specific$Cl)` mg/L.

- `r str_to_title(Lake_Name[1])` falls into the `r Percentile_only_Cl`th percentile of Cl concentrations in off-shield lakes. Meaning `r str_to_title(Lake_Name[1])` is `r if(between(Specific_Percentile_Cl$percentile, 0, 50) == TRUE) {"in the lower 50% of off-Shield lakes in the LPP, regarding Cl concentrations."}` `r if(between(Specific_Percentile_Cl$percentile, 51, 100) == TRUE) {"in the upper 50% of off-Shield lakes in the LPP, regarding Cl concentrations."}`


Row{data-height=750}
-----------------------------
### What is `r str_to_title(Lake_Name[1])`'s annual chloride levels?

```{r setting up for cl annual, include=FALSE}

R_value_Cl <- cor.test(Annual_Cl_Specific$Cl, Annual_Cl_Specific$Year)
R_value_Cl <- R_value_Cl$estimate
R_value_Cl <- unname(R_value_Cl)


Max_Year_Cl <- Annual_Cl_Specific %>% 
  arrange(desc(Cl)) %>% 
  slice_head()
Max_Year_Cl <- as.character(Max_Year_Cl)


Min_Year_Cl <- Annual_Cl_Specific %>% 
  arrange(Cl) %>% 
  slice_head() 
Min_Year_Cl <- as.character(Min_Year_Cl)

```

```{r annual Cl graph, echo=FALSE, fig.height=3, fig.width=10, message=FALSE, warning=FALSE}
ggplot()+
  geom_line(Annual_Cl_Specific, mapping = aes(x = Year, y = Cl), color = "Black", linewidth = 2) +
  labs(x = "Year", y = "Annual Cl (mg/L)")+ 
  geom_point(Annual_Cl_Specific, mapping = aes(x= Year, y = Cl), color = "Navy Blue", size = 5) +
  geom_smooth(Annual_Cl_Specific, mapping= aes(x= Year, y = Cl), linetype = 2, color = "Black") +
  theme_classic(base_size = 25) +
  geom_hline(data = LPP_Cl %>% filter(Shield. == "TRUE"), linetype= 2,##trying to figure out how to optimize this
             mapping = aes(yintercept = mean(Cl))) +
  geom_text(aes(label = "On Shield Lake Cl Average", x = 2018, y = (mean(LPP_Cl %>% filter(Shield.=="TRUE"))))) +
 geom_text(data=data.frame(), aes(label = paste("R-square =", round(R_value_Cl, 1)), x= -Inf, y= Inf), hjust = -6, vjust = 3.5, size= 4)

```

>**Figure 9.** A line plot showing that `r str_to_title(Lake_Name[1])` `r if(between(R_value_Cl, -10, -0.1) == TRUE) {"declined in chloride by approximately"}` `r if(between(R_value_Cl, 0.1, 10) == TRUE) {"increased in chloride  by approximately"}` `r if(between(R_value_Cl, -0.1, 0.1) == TRUE) {"stayed relatively the same at"}` `r R_value_Cl` µg/L per year from `r min(Year_Character_Cl)` to `r max(Year_Character_Cl)`. Data were collected through the LPP in the spring of each year.

Row
---------------------------------------------

### Highlights from `r str_to_title(Lake_Name[1])`'s annual chloride concentrations: {.takeawayfig9}
- Annually the Cl concentration in `r str_to_title(Lake_Name[1])` has `r if(between(R_value_Cl, -100, -0.1) == TRUE) {"fallen by"}` `r if(between(R_value_Cl, 0.1, 100) == TRUE) {"risen by"}` `r if(between(R_value_Cl, -0.1, 0.1) == TRUE) {"stayed relatively the same at"}` `r R_value_Cl` mg/L annually. 

- `r str_to_title(Lake_Name[1])` has some variability in Cl concentrations from year-to-year. For example Cl concentrations have ranged from `r min(Annual_Cl_Specific$Cl)` µg/L in `r Min_Year_Cl[1]` to `r max(Annual_Cl_Specific$Cl)` mg/L in `r Max_Year_Cl[1]` since testing began in `r min(Year_Character_Cl)`. Due to the number of years of data for `r str_to_title(Lake_Name[1])`, we can assume this variability is representative of normal conditions for this lake.

Row {data-height=80}
--------------------------------
***<font size="-1">Yao, H., Paterson, A. M., James, A. L., McConnell, C., Field, T., Ingram, R., Zhang, D., Arnott, E., Higgins, S. N. (2020). Contrasting long-term trends of chloride levels in remote and human-disturbed lakes in south-central Ontario, Canada. Lake and Reservoir Management. DOI: 10.1080/10402381.2020.1820642 </font>***

Row {data-height=80}
--------------------------------
***<font size="-1"> The LPP measures water quality in inland lakes across Ontario. The data is collected through volunteer monitoring efforts - citizen science. You can download the data set used in this analysis by visiting the Ontario Open Data Catalog at data.ontario.ca/dataset/ontario-lake-partner </font>***

Water Clarity
=============================================
### **<font size = "+3"> What is Secchi Depth?** </font>
LPP volunteers track the water clarity of their lake using a piece of equipment called a Secchi disk. In Ontario, Secchi depth is directly related to the depth at which light can penetrate the lake. Light penetration into the lake can be controlled by dissolved organic carbon (DOC), biological turbidity (e.g. algae) and non-biological turbidity, which can influence the colour of the lake.
<br>
Water clarity readings with a Secchi disk are valuable for tracking lake changes that would not be observed by monitoring TP concentrations on their own. Such as the impacts of invasive species (e.g. zebra mussels), climate change effects, or watershed disturbances. Long-term trends in water clarity are also significant because they are directly linked to the value of property in Ontario.

Row {data-height=750}
--------------------------------------------

### How does `r str_to_title(Lake_Name[1])`'s water clarity compare to other off-Shield lakes?
```{r setting up for secchi Histogram, include=FALSE}
Lake_AVG_Sec_ON <- LPP_Sec %>% 
  mutate(Year = lubridate::year(Date),
         Month = lubridate::month(Date)) %>% 
  filter(Month == "6" | Month == "7" | Month == "8")

Lake_AVG_Sec_ON <- Lake_AVG_Sec_ON %>% 
  group_by(STN) %>% 
  mutate(Secchi = mean(Secchi)) %>% 
  reframe(STN, LAKE_NAME, Secchi, Shield.) %>% 
  distinct() %>%
  filter(Shield. == "TRUE") %>% 
  ungroup()

Lake_AVG_Sec_ON <- Lake_AVG_Sec_ON %>% 
  mutate(percentile = ((rank(Secchi)/length(Secchi))*100))

Specific_Percentile_Sec <- Lake_AVG_Sec_ON %>% 
  filter_STN() %>%
  mutate(percentile = round(percentile, 0)) 
  
Percentile_only_Sec <- as.character(Specific_Percentile_Sec$percentile) 

```

```{r secchi histogram, fig.height=3, fig.width=10, message=FALSE, warning=FALSE}
ggplot(Lake_AVG_Sec_ON)+
  geom_histogram(binwidth = 1, color = "white", aes(x = Secchi, y=(after_stat(count)/sum(after_stat(count))*100)))+
  labs(x = "Secchi Depth (m)", y = "Lakes (%)")+
  scale_x_continuous(limits = c(0,10), breaks = seq(0, 10, by = 1))+
  scale_y_continuous(limits = c(0,40), breaks = seq(0, 40, by = 5))+
  geom_vline(xintercept = (mean(Annual_Sec_Specific$Secchi)), linetype = "longdash")+
  geom_text(aes(x = (mean(Annual_Sec_Specific$Secchi)), y = 35, label = (Annual_Sec_Specific$LAKE_NAME[1])), colour="springgreen4", angle = 0, hjust= -0.1, size = 4)+
  theme_cowplot() +
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 15), 
        axis.title.y = element_text(vjust = 2),
        axis.title.x = element_text(vjust = -0.5))


```

>**Figure 10.** Histogram showing the distribution of secchi depths for all off-Shield lakes in the LPP from `r min(Year_Character_Sec)` to `r max(Year_Character_Sec)`. The dash and dot line represents `r str_to_title(Lake_Name[1])` average secchi depths. Only secchi depths taken in June, July, and August due to research showing these are the most stable months for secchi depth readings. 

Row 
--------------------------------------------
### Highlights from `r str_to_title(Lake_Name[1])`'s comparison to other off-Shield lakes: {.takeawayfig10}

-	The average secchi depths between `r min(Year_Character_Sec)` and `r max(Year_Character_Sec)` is `r mean(Annual_Sec_Specific$Secchi)` m.

- `r str_to_title(Lake_Name[1])` falls into the `r Percentile_only_Sec`th percentile of secchi levels in off-shield lakes. Meaning `r str_to_title(Lake_Name[1])` is `r if(between(Specific_Percentile_Sec$percentile, 0, 50) == TRUE) {"in the lower 50% of On-Shield lakes in the LPP, regarding secchi depth."}` `r if(between(Specific_Percentile_Sec$percentile, 51, 100) == TRUE) {"in the upper 50% of On-Shield lakes in the LPP, regarding secchi levels."}`

Row {data-height=750}
--------------------------------------------
### What is `r str_to_title(Lake_Name[1])`'s annual secchi depths?

```{r Setting up for annual secchi graph, include=FALSE}

R_value_Sec <- cor.test(Annual_Sec_Specific$Secchi, Annual_Sec_Specific$Year)
R_value_Sec <- R_value_Sec$estimate
R_value_Sec <- unname(R_value_Sec)


Max_Year_Sec <- Annual_Sec_Specific %>% 
  arrange(desc(Secchi)) %>% 
  slice_head()
Max_Year_Sec <- as.character(Max_Year_Sec)


Min_Year_Sec <- Annual_Sec_Specific %>% 
  arrange(Secchi) %>% 
  slice_head() 
Min_Year_Sec <- as.character(Min_Year_Sec)

```

```{r annual secchi graph, fig.height=3, fig.width=10, echo=FALSE}
ggplot()+
  geom_line(Annual_Sec_Specific, mapping = aes(x = Year, y = Secchi), color = "Black", linewidth = 2) +
  labs(x = "Year", y = "Secchi Depth (m)")+ 
  geom_point(Annual_Sec_Specific, mapping = aes(x= Year, y = Secchi), color = "Navy Blue", size = 5) +
  geom_smooth(Annual_Sec_Specific, mapping= aes(x= Year, y = Secchi), linetype = 2, color = "Black") +
  theme_classic(base_size = 25) +
  geom_hline(data = LPP_Sec %>% filter(Shield. == "TRUE"), linetype= 2,##trying to figure out how to optimize this
             mapping = aes(yintercept = mean(Secchi))) +
  geom_text(aes(label = "On Shield Secchi Depth AVG", x = 2013, y = (mean(LPP_Sec %>% filter(Shield.=="TRUE"))))) +
  geom_text(data=data.frame(), aes(label = paste("R-square =", round(R_value_Sec, 1)), x= -Inf, y= Inf), hjust = -6, vjust = 3.5, size= 4)+
  scale_y_continuous(limits = c(0,10), breaks = seq(0, 10, by = 2))
  

```

>**Figure 11.** A line plot showing that `r str_to_title(Lake_Name[1])` `r if(between(R_value_Sec, -10, -0.1) == TRUE) {"water clarity decreased by approximately"}` `r if(between(R_value_Sec, 0.1, 10) == TRUE) {"water clarity increased by approximately"}` `r if(between(R_value_Sec, -0.1, 0.1) == TRUE) {"stayed relatively the same at"}` `r R_value_Sec` m per year from `r min(Year_Character_Sec)` to `r max(Year_Character_Sec)`. Data were collected through the LPP from May to October each year.

Row
-----------------------------------------
### Highlights from `r str_to_title(Lake_Name[1])`'s annual water clarity levels: {.takeawayfig11}

- Annually the water clarity in `r str_to_title(Lake_Name[1])` has `r if(between(R_value_Sec, -100, -0.01) == TRUE) {"decreased by"}` `r if(between(R_value_Sec, 0.01, 100) == TRUE) {"increased by"}` `r if(between(R_value_Sec, -0.1, 0.1) == TRUE) {"stayed relatively the same at"}` `r R_value_Sec` m annually. 

- `r str_to_title(Lake_Name[1])` has some variability in water clarity levels from year-to-year. For example water clarity has ranged from `r min(Annual_Sec_Specific$Secchi)` m in `r Min_Year_Sec[5]` to `r max(Annual_Sec_Specific$Secchi)` m in `r Max_Year_Sec[5]` since testing began in `r min(Year_Character_Sec)`. Due to the number of years of data for `r str_to_title(Lake_Name[1])`, we can assume this variability is representative of normal conditions for this lake. 

Row {data-height=90}
--------------------------------------
***<font size="-1"> The LPP measures water quality in inland lakes across Ontario. The data is collected through volunteer monitoring efforts - citizen science. You can download the data set used in this analysis by visiting the Ontario Open Data Catalog at data.ontario.ca/dataset/ontario-lake-partner </font>***
